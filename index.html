<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FIT3179 A2 â€” AFL Membership Geography (2024)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: light;
    }
    body {
      font-family: "Segoe UI", "Helvetica Neue", Arial, system-ui, sans-serif;
      margin: 24px;
      line-height: 1.5;
      background: #ffffff;
      color: #1b1b1b;
    }
    h1 {
      margin-bottom: 0.3rem;
      font-size: 2.1rem;
    }
    h2 {
      font-size: 1.25rem;
      margin-top: 2rem;
    }
    p {
      max-width: 820px;
    }
    .vis-container {
      margin-top: 24px;
    }
    .grid {
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      align-items: start;
    }
    figure {
      margin: 0;
    }
    figcaption {
      margin-top: 12px;
      font-size: 0.95rem;
      color: #3a3a3a;
      max-width: 920px;
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }
    footer {
      margin-top: 32px;
      font-size: 0.95rem;
      max-width: 820px;
      color: #333;
    }
    a {
      color: #0050b3;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
</head>
<body>
  <header>
    <h1>AFL Club Memberships (2024)</h1>
    <p class="lead">Mapping the 2024 membership strongholds and contrasting club and state totals. Hover to highlight across the views; click to filter (Shift+click adds to selection, double-click clears).</p>
  </header>

  <section aria-labelledby="dashboard-title" class="vis-container">
    <h2 id="dashboard-title" class="sr-only">Interactive membership dashboard</h2>
    <figure>
      <div id="vis-map"></div>
      <div class="grid">
        <div id="vis-leaderboard"></div>
        <div id="vis-state"></div>
      </div>
      <figcaption>
        The map sizes each club's home ground circle by 2024 membership and colours by state. The leaderboard ranks clubs with the median marked and annotations on the top three. The state chart aggregates memberships, enabling a VIC versus interstate comparison.
      </figcaption>
      <p class="sr-only" id="map-summary">Victoria hosts the largest membership bases (Collingwood, Carlton, Richmond). Western Australia's West Coast is the biggest non-Victorian club, while Queensland clubs are smaller yet growing.</p>
    </figure>
  </section>

  <footer>
    <strong>Takeaway:</strong> Victorian clubs dominate total memberships, but the national footprint is anchored by West Coast (WA) and Adelaide (SA); NSW and QLD clubs trail, highlighting future growth markets.
  </footer>

  <script>
    const baseConfig = {
      font: "Segoe UI, 'Helvetica Neue', Arial, system-ui, sans-serif",
      axis: { labelFontSize: 12, titleFontSize: 13, labelColor: "#20262e", titleColor: "#20262e" },
      legend: { labelFontSize: 12, titleFontSize: 13, labelColor: "#20262e", titleColor: "#20262e" },
      header: { titleFontSize: 16, labelFontSize: 14 },
      title: { fontSize: 18, anchor: "start", color: "#111" },
      view: { stroke: "#d0d7de" }
    };

    const mapSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      width: 920,
      height: 520,
      background: "white",
      padding: 12,
      config: baseConfig,
      params: [
        { name: "clubHover", value: null },
        { name: "clubFilter", value: [] },
        { name: "stateFilter", value: [] }
      ],
      projection: { type: "equalEarth" },
      layer: [
        {
          data: { sphere: {} },
          mark: { type: "geoshape", fill: "#f3f5f7", stroke: "#c4cacf", strokeWidth: 0.5 }
        },
        {
          data: {
            url: "https://cdn.jsdelivr.net/npm/vega-datasets@2.9.1/data/world-110m.json",
            format: { type: "topojson", feature: "countries" }
          },
          mark: { type: "geoshape", fill: "#e2e8f0", stroke: "#c4cacf", strokeWidth: 0.5 }
        },
        {
          data: { url: "data/afl_clubs_2024_geo.csv" },
          transform: [
            { filter: "!length(stateFilter) || indexof(stateFilter, datum.state) >= 0" },
            { filter: "!length(clubFilter) || indexof(clubFilter, datum.club) >= 0" }
          ],
          mark: { type: "circle", opacity: 0.95, stroke: "#1f2933" },
          encoding: {
            longitude: { field: "lon", type: "quantitative" },
            latitude: { field: "lat", type: "quantitative" },
            size: {
              field: "membership_2024",
              type: "quantitative",
              scale: { range: [900, 5000] },
              legend: { title: "Members" }
            },
            color: { field: "state", type: "nominal", legend: { title: "State" }, scale: { scheme: "tableau10" } },
            tooltip: [
              { field: "club", title: "Club" },
              { field: "ground", title: "Home ground" },
              { field: "membership_2024", title: "Members (2024)", format: "," },
              { field: "state", title: "State" }
            ],
            opacity: {
              condition: [
                { test: "clubHover && datum.club === clubHover", value: 1 },
                { test: "!length(clubFilter) || indexof(clubFilter, datum.club) >= 0", value: 0.95 }
              ],
              value: 0.25
            },
            strokeWidth: {
              condition: { test: "clubHover && datum.club === clubHover", value: 2.5 },
              value: 1
            }
          }
        },
        {
          data: { url: "data/afl_clubs_2024_geo.csv" },
          transform: [
            { filter: "indexof(['Collingwood','Carlton','West Coast'], datum.club) >= 0" }
          ],
          mark: { type: "text", dy: -18, fontWeight: "bold", fill: "#0f172a" },
          encoding: {
            longitude: { field: "lon", type: "quantitative" },
            latitude: { field: "lat", type: "quantitative" },
            text: { field: "club" }
          }
        }
      ]
    };

    const leaderboardSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      width: 450,
      height: 520,
      background: "white",
      padding: 12,
      config: baseConfig,
      data: { url: "/data/afl_memberships_2024.csv" },
      params: [
        { name: "clubHover", value: null },
        { name: "clubFilter", value: [] },
        { name: "stateFilter", value: [] }
      ],
      transform: [
        {
          lookup: "club",
          from: { data: { url: "../data/afl_club_homegrounds.csv" }, key: "club", fields: ["state"] }
        },
        { filter: "!length(stateFilter) || indexof(stateFilter, datum.state) >= 0" },
        {
          window: [
            { op: "rank", as: "membership_rank" }
          ],
          sort: [{ field: "membership_2024", order: "descending" }]
        },
        {
          joinaggregate: [
            { op: "median", field: "membership_2024", as: "median_membership" }
          ]
        },
        {
          calculate: "datum.membership_rank <= 3 ? 'Top ' + datum.membership_rank : ''",
          as: "top_label"
        }
      ],
      title: {
        text: "Club leaderboard",
        subtitle: "Bars sort by 2024 members; dashed rule marks the median."
      },
      layer: [
        {
          mark: { type: "rule", color: "#444", strokeDash: [6, 4] },
          encoding: {
            x: { field: "median_membership", type: "quantitative" }
          }
        },
        {
          mark: { type: "bar", cornerRadiusEnd: 4 },
          encoding: {
            y: { field: "club", type: "nominal", sort: "-x", title: null },
            x: { field: "membership_2024", type: "quantitative", title: "Members (2024)", axis: { format: "," } },
            color: {
              field: "state",
              type: "nominal",
              legend: { title: "State" },
              scale: { scheme: "tableau10" }
            },
            opacity: {
              condition: [
                { test: "clubHover && datum.club === clubHover", value: 1 },
                { test: "!length(clubFilter) || indexof(clubFilter, datum.club) >= 0", value: 0.95 }
              ],
              value: 0.3
            },
            tooltip: [
              { field: "club", title: "Club" },
              { field: "membership_2024", title: "Members (2024)", format: "," },
              { field: "state", title: "State" }
            ]
          }
        },
        {
          transform: [{ filter: "datum.top_label != ''" }],
          mark: { type: "text", align: "left", dx: 4, dy: 0, fontWeight: "bold", fill: "#0f172a" },
          encoding: {
            y: { field: "club", type: "nominal", sort: "-x" },
            x: { field: "membership_2024", type: "quantitative" },
            text: { field: "top_label", type: "nominal" }
          }
        }
      ]
    };

    const stateSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      width: 450,
      height: 520,
      background: "white",
      padding: 12,
      config: baseConfig,
      data: { url: "/data/afl_memberships_2024.csv" },
      params: [
        { name: "clubHover", value: null },
        { name: "clubFilter", value: [] },
        { name: "stateFilter", value: [] }
      ],
      transform: [
        {
          lookup: "club",
          from: { data: { url: "/data/afl_club_homegrounds.csv" }, key: "club", fields: ["state"] }
        },
        { filter: "!length(stateFilter) || indexof(stateFilter, datum.state) >= 0" },
        { filter: "!length(clubFilter) || indexof(clubFilter, datum.club) >= 0" },
        {
          aggregate: [
            { op: "sum", field: "membership_2024", as: "total_membership" }
          ],
          groupby: ["state"]
        }
      ],
      title: {
        text: "Membership by state",
        subtitle: "Totals respond to club selections; click a bar to focus on a state."
      },
      mark: { type: "bar", cornerRadiusEnd: 4 },
      encoding: {
        y: { field: "state", type: "nominal", sort: "-x", title: "State" },
        x: { field: "total_membership", type: "quantitative", title: "Total members (2024)", axis: { format: "," } },
        color: {
          field: "state",
          type: "nominal",
          legend: null,
          scale: { scheme: "tableau10" }
        },
        opacity: {
          condition: [
            { test: "!length(stateFilter) || indexof(stateFilter, datum.state) >= 0", value: 0.95 }
          ],
          value: 0.3
        },
        tooltip: [
          { field: "state", title: "State" },
          { field: "total_membership", title: "Total members", format: "," }
        ]
      }
    };

    Promise.all([
      vegaEmbed("#vis-map", mapSpec, { actions: false }),
      vegaEmbed("#vis-leaderboard", leaderboardSpec, { actions: false }),
      vegaEmbed("#vis-state", stateSpec, { actions: false })
    ]).then(([mapResult, leaderboardResult, stateResult]) => {
      const mapView = mapResult.view;
      const leaderboardView = leaderboardResult.view;
      const stateView = stateResult.view;
      const views = [mapView, leaderboardView, stateView];

      let clubHover = null;
      let clubFilter = [];
      let stateFilter = [];

      const runAll = () => Promise.all(views.map((view) => view.runAsync()));

      const setSignalAll = (name, value) => {
        views.forEach((view) => view.signal(name, value));
      };

      const updateClubHover = (club) => {
        clubHover = club;
        setSignalAll("clubHover", clubHover);
        runAll();
      };

      const updateClubFilter = (clubs) => {
        clubFilter = clubs;
        setSignalAll("clubFilter", clubFilter);
        runAll();
      };

      const updateStateFilter = (states) => {
        stateFilter = states;
        setSignalAll("stateFilter", stateFilter);
        runAll();
      };

      const toggleValue = (array, value, additive) => {
        if (!value) return array;
        const exists = array.includes(value);
        if (additive) {
          if (exists) {
            return array.filter((item) => item !== value);
          }
          return [...array, value];
        }
        return [value];
      };

      const handleClubClick = (event, item) => {
        if (event.type === "dblclick") {
          updateClubFilter([]);
          return;
        }
        const club = item && item.datum && item.datum.club;
        if (!club) {
          if (!event.shiftKey) updateClubFilter([]);
          return;
        }
        const next = toggleValue(clubFilter, club, event.shiftKey);
        updateClubFilter(next);
      };

      const handleStateClick = (event, item) => {
        if (event.type === "dblclick") {
          updateStateFilter([]);
          return;
        }
        const state = item && item.datum && item.datum.state;
        if (!state) {
          if (!event.shiftKey) updateStateFilter([]);
          return;
        }
        const next = toggleValue(stateFilter, state, event.shiftKey);
        updateStateFilter(next);
      };

      const clubHoverIn = (event, item) => {
        const club = item && item.datum && item.datum.club;
        if (club) updateClubHover(club);
      };

      const clubHoverOut = () => {
        updateClubHover(null);
      };

      mapView.addEventListener("pointerover", clubHoverIn);
      mapView.addEventListener("pointerout", clubHoverOut);
      leaderboardView.addEventListener("pointerover", clubHoverIn);
      leaderboardView.addEventListener("pointerout", clubHoverOut);

      mapView.addEventListener("click", handleClubClick);
      mapView.addEventListener("dblclick", handleClubClick);
      leaderboardView.addEventListener("click", handleClubClick);
      leaderboardView.addEventListener("dblclick", handleClubClick);

      stateView.addEventListener("click", handleStateClick);
      stateView.addEventListener("dblclick", handleStateClick);
    });
  </script>
</body>
</html>
