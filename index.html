<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FIT3179 A2 â€” AFL Membership Geography (2024)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;500;600;700&family=Oswald:wght@500;600&display=swap"
    rel="stylesheet"
  />
  <style>
    :root {
      color-scheme: light;
      font-size: 18px;
      --page-max-width: 1080px;
      --page-padding: clamp(1.5rem, 4vw, 3rem);
      --text-colour: #1b1f26;
      --muted-colour: #3e4859;
      --accent-colour: #0b4aa3;
      --background-colour: #f7f8fb;
    }
    body {
      margin: 0;
      font-family: "Barlow", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      font-weight: 400;
      line-height: 1.7;
      color: var(--text-colour);
      background: var(--background-colour);
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
    }
    .page {
      max-width: var(--page-max-width);
      margin: 0 auto;
      padding: var(--page-padding);
      background: #fff;
      box-shadow: 0 18px 50px rgba(21, 36, 56, 0.08);
      border-radius: 18px;
    }
    header {
      max-width: 68ch;
      margin-bottom: 2.5rem;
    }
    h1 {
      margin: 0 0 0.5rem;
      font-family: "Oswald", "Barlow", "Segoe UI", sans-serif;
      font-size: clamp(2.4rem, 5vw, 3.2rem);
      font-weight: 600;
      letter-spacing: 0.045em;
      text-transform: uppercase;
      color: #0b234a;
    }
    h2 {
      margin: 2.8rem 0 1rem;
      font-family: "Oswald", "Barlow", "Segoe UI", sans-serif;
      font-size: clamp(1.35rem, 3.1vw, 1.85rem);
      font-weight: 500;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #102a56;
    }
    p,
    li {
      max-width: 70ch;
      font-size: 1rem;
      letter-spacing: 0.01em;
    }
    p {
      margin: 0.75rem 0 0;
      color: var(--muted-colour);
    }
    header p:first-of-type {
      margin-top: 0.5rem;
      font-size: 1.05rem;
      color: var(--text-colour);
      font-weight: 500;
    }
    .vis {
      margin: 1.5rem 0;
    }
    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: clamp(1.5rem, 3vw, 2.5rem);
      align-items: start;
    }
    section {
      max-width: 70ch;
      margin-top: 2rem;
    }
    ul {
      padding-left: 1.2rem;
      margin: 1rem 0 0;
      display: grid;
      gap: 0.65rem;
    }
    li {
      color: var(--muted-colour);
      line-height: 1.65;
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    button {
      font-family: "Oswald", "Barlow", sans-serif;
      font-size: 0.95rem;
      letter-spacing: 0.08em;
      padding: 0.65rem 1.15rem;
      border-radius: 999px;
      border: 2px solid var(--accent-colour);
      background: var(--accent-colour);
      color: #fff;
      cursor: pointer;
      text-transform: uppercase;
      font-weight: 500;
      transition: background 160ms ease, color 160ms ease, box-shadow 160ms ease;
      box-shadow: 0 12px 24px rgba(11, 74, 163, 0.18);
    }
    button:hover,
    button:focus-visible {
      background: #0a3a7d;
      border-color: #0a3a7d;
      box-shadow: 0 10px 28px rgba(11, 74, 163, 0.24);
    }
    button:focus-visible {
      outline: 3px solid rgba(11, 74, 163, 0.4);
      outline-offset: 3px;
    }
    footer {
      margin-top: 3rem;
      font-size: 0.95rem;
      color: var(--muted-colour);
      letter-spacing: 0.02em;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
</head>
<body>
  <div class="page">
    <header>
      <h1>AFL Club Memberships (2024)</h1>
      <p>Mapping where supporters congregate around each club. Membership scale drives the circle sizes, with linked charts ranking clubs and totalling each state.</p>
      <p id="map-alt" class="sr-only">Interactive dashboard showing an Equal Earth map of AFL club home grounds sized by 2024 memberships, a leaderboard of club totals, and a state-level membership summary. Hover highlights clubs and states; clicking filters selections, with a reset button available.</p>
    </header>

    <main>
      <div id="vis-map" class="vis" aria-describedby="map-alt"></div>
      <div class="row">
        <div>
          <h2>Club leaderboard</h2>
          <div id="vis-leaderboard" class="vis"></div>
        </div>
        <div>
          <h2>State share of members</h2>
          <div id="vis-state" class="vis"></div>
        </div>
      </div>
      <button id="reset-filters" type="button">Reset selections</button>

      <section>
        <h2>What stands out?</h2>
        <ul>
          <li>Collingwood and Carlton eclipse the competition, breaking the 100k member mark and anchoring Victoria&rsquo;s dominance.</li>
          <li>West Coast remains the west coast powerhouse despite a smaller state population, while Sydney&rsquo;s clubs trail their Victorian peers.</li>
          <li>Filtering reveals how interstate clubs (WA, SA, NSW, QLD) stack up when isolated from Victoria&rsquo;s deep supporter bases.</li>
        </ul>
      </section>
    </main>

    <footer>
      <strong>Notes:</strong> Equal Earth projection using WGS84 ground coordinates. Membership data: official AFL 2024 totals.
    </footer>
  </div>

  <script>
    const sharedParams = [
      { name: "hoverClub", value: null },
      { name: "hoverState", value: null },
      { name: "selectedClubs", value: [] },
      { name: "selectedStates", value: [] }
    ];

    function withSharedParams(spec) {
      return { ...spec, params: [...sharedParams.map(p => ({ ...p }))] };
    }

    function dataBasePath() {
      const { pathname, protocol, host } = window.location;
      const segments = pathname.split("/").filter(Boolean);

      if (segments.length && segments[segments.length - 1].includes(".")) {
        segments.pop();
      }

      const srcIndex = segments.lastIndexOf("src");
      if (srcIndex !== -1) {
        segments.splice(srcIndex);
      }

      const joined = segments.join("/");
      const basePath = joined ? `/${joined}/` : "/";
      const prefix = protocol === "file:" ? "file://" : `${protocol}//${host}`;

      return `${prefix}${basePath}data/`;
    }

    function resolveDataUrl(fileName) {
      return `${dataBasePath()}${fileName}`;
    }

    const dataUrl = resolveDataUrl("afl_clubs_2024_geo.csv");
    const australiaTopoUrl = resolveDataUrl("world-110m.json");

    const mapSpec = withSharedParams({
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      width: 900,
      height: 520,
      data: { url: dataUrl },
      projection: {
        type: "equalEarth",
        center: [133.7751, -25.2744],
        scale: 1200
      },
      layer: [
        {
          data: {
            url: australiaTopoUrl,
            format: { type: "topojson", feature: "countries" }
          },
          transform: [{ filter: "datum.properties.name == 'Australia'" }],
          mark: { type: "geoshape", fill: "#e8f1fb", stroke: "#8eaed0", strokeWidth: 1.2, clip: true }
        },
        {
          data: { graticule: true },
          mark: { type: "geoshape", stroke: "#d0d0d0", strokeWidth: 0.5, fill: "transparent", clip: true }
        },
        {
          transform: [
            { filter: "selectedClubs.length == 0 || indexof(selectedClubs, datum.club) >= 0" },
            { filter: "selectedStates.length == 0 || indexof(selectedStates, datum.state) >= 0" }
          ],
          mark: { type: "circle", opacity: 0.9, strokeWidth: 1.5 },
          encoding: {
            longitude: { field: "lon", type: "quantitative" },
            latitude: { field: "lat", type: "quantitative" },
            size: {
              field: "membership_2024",
              type: "quantitative",
              title: "Members (2024)",
              scale: { range: [750, 3200] }
            },
            color: {
              field: "state",
              type: "nominal",
              legend: { title: "State" },
              scale: { scheme: "tableau10" }
            },
            opacity: {
              condition: [
                { test: "hoverClub != null && datum.club == hoverClub", value: 1 },
                { test: "hoverClub == null && hoverState != null && datum.state == hoverState", value: 0.95 },
                { test: "indexof(selectedClubs, datum.club) >= 0", value: 1 },
                { test: "selectedClubs.length == 0 && selectedStates.length > 0 && indexof(selectedStates, datum.state) >= 0", value: 0.95 }
              ],
              value: 0.35
            },
            stroke: {
              condition: {
                test: "indexof(selectedClubs, datum.club) >= 0",
                value: "#1a1a1a"
              },
              value: "#ffffff"
            },
            tooltip: [
              { field: "club", title: "Club" },
              { field: "ground", title: "Home ground" },
              { field: "membership_2024", title: "Members (2024)", format: "," },
              { field: "state", title: "State" }
            ]
          }
        },
        {
          transform: [
            { window: [{ op: "rank", as: "rank_membership" }], sort: [{ field: "membership_2024", order: "descending" }] },
            { filter: "datum.rank_membership <= 3" }
          ],
          mark: { type: "text", dy: -18, fontWeight: "bold", fontSize: 12, fill: "#111", stroke: "white", strokeWidth: 3, strokeOpacity: 0.8 },
          encoding: {
            longitude: { field: "lon", type: "quantitative" },
            latitude: { field: "lat", type: "quantitative" },
            text: {
              signal: "datum.rank_membership + '. ' + datum.club + ' (' + format(datum.membership_2024, ',') + ')'"
            }
          }
        }
      ]
    });

    const leaderboardSpec = withSharedParams({
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      width: 460,
      height: 520,
      data: { url: dataUrl },
      transform: [
        { filter: "selectedClubs.length == 0 || indexof(selectedClubs, datum.club) >= 0" },
        { filter: "selectedStates.length == 0 || indexof(selectedStates, datum.state) >= 0" },
        { aggregate: [{ op: "max", field: "membership_2024", as: "membership_2024" }], groupby: ["club", "state"] },
        { window: [{ op: "rank", as: "rank_membership" }], sort: [{ field: "membership_2024", order: "descending" }] }
      ],
      layer: [
        {
          mark: { type: "bar", cornerRadiusEnd: 4 },
          encoding: {
            y: { field: "club", type: "nominal", sort: "-x", title: null },
            x: {
              field: "membership_2024",
              type: "quantitative",
              title: "Members (2024)",
              axis: { format: "," }
            },
            color: {
              field: "state",
              type: "nominal",
              legend: { title: "State" },
              scale: { scheme: "tableau10" }
            },
            opacity: {
              condition: [
                { test: "hoverClub != null && datum.club == hoverClub", value: 1 },
                { test: "hoverClub == null && hoverState != null && datum.state == hoverState", value: 0.95 },
                { test: "indexof(selectedClubs, datum.club) >= 0", value: 1 },
                { test: "selectedClubs.length == 0 && selectedStates.length > 0 && indexof(selectedStates, datum.state) >= 0", value: 0.95 }
              ],
              value: 0.4
            },
            tooltip: [
              { field: "club", title: "Club" },
              { field: "membership_2024", title: "Members (2024)", format: "," },
              { field: "state", title: "State" }
            ]
          }
        },
        {
          transform: [{ filter: "datum.rank_membership <= 3" }],
          mark: { type: "text", align: "left", dx: 6, fontWeight: "bold", fill: "#111" },
          encoding: {
            y: { field: "club", type: "nominal", sort: "-x" },
            x: { field: "membership_2024", type: "quantitative" },
            text: {
              signal: "'Top ' + datum.rank_membership"
            }
          }
        },
        {
          transform: [
            { aggregate: [{ op: "median", field: "membership_2024", as: "median_membership" }] }
          ],
          mark: { type: "rule", color: "#6f6f6f", strokeDash: [4, 4], strokeWidth: 2 },
          encoding: {
            x: { field: "median_membership", type: "quantitative" }
          }
        },
        {
          transform: [
            { aggregate: [{ op: "median", field: "membership_2024", as: "median_membership" }] }
          ],
          mark: { type: "text", dy: -8, dx: 4, align: "left", baseline: "bottom", fill: "#333", fontWeight: "bold" },
          encoding: {
            x: { field: "median_membership", type: "quantitative" },
            y: { value: -10 },
            text: { signal: "'Median: ' + format(datum.median_membership, ',')" }
          }
        }
      ]
    });

    const stateSpec = withSharedParams({
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      width: 460,
      height: 520,
      data: { url: dataUrl },
      transform: [
        { filter: "selectedClubs.length == 0 || indexof(selectedClubs, datum.club) >= 0" },
        { filter: "selectedStates.length == 0 || indexof(selectedStates, datum.state) >= 0" },
        { aggregate: [{ op: "sum", field: "membership_2024", as: "total_membership" }], groupby: ["state"] },
        { window: [{ op: "rank", as: "rank_state" }], sort: [{ field: "total_membership", order: "descending" }] }
      ],
      layer: [
        {
          mark: { type: "bar", cornerRadiusEnd: 4 },
          encoding: {
            y: { field: "state", type: "nominal", sort: "-x", title: "State" },
            x: {
              field: "total_membership",
              type: "quantitative",
              title: "Total members (2024)",
              axis: { format: "," }
            },
            color: {
              field: "state",
              type: "nominal",
              legend: null,
              scale: { scheme: "tableau10" }
            },
            opacity: {
              condition: [
                { test: "hoverState != null && datum.state == hoverState", value: 1 },
                { test: "indexof(selectedStates, datum.state) >= 0", value: 1 }
              ],
              value: 0.4
            },
            tooltip: [
              { field: "state", title: "State" },
              { field: "total_membership", title: "Members (2024)", format: "," }
            ]
          }
        },
        {
          transform: [{ filter: "datum.rank_state == 1" }],
          mark: { type: "text", align: "left", dx: 6, fontWeight: "bold", fill: "#111" },
          encoding: {
            y: { field: "state", type: "nominal" },
            x: { field: "total_membership", type: "quantitative" },
            text: { value: "Largest share" }
          }
        }
      ]
    });

    const embedOptions = { actions: false }; // hide export menu

    const sharedState = {
      hoverClub: null,
      hoverState: null,
      selectedClubs: [],
      selectedStates: []
    };

    Promise.all([
      vegaEmbed("#vis-map", mapSpec, embedOptions),
      vegaEmbed("#vis-leaderboard", leaderboardSpec, embedOptions),
      vegaEmbed("#vis-state", stateSpec, embedOptions)
    ]).then(([mapRes, leaderboardRes, stateRes]) => {
      const mapView = mapRes.view;
      const leaderboardView = leaderboardRes.view;
      const stateView = stateRes.view;
      const allViews = [mapView, leaderboardView, stateView];

      function syncViews() {
        allViews.forEach((view) => {
          view.signal("hoverClub", sharedState.hoverClub);
          view.signal("hoverState", sharedState.hoverState);
          view.signal("selectedClubs", sharedState.selectedClubs);
          view.signal("selectedStates", sharedState.selectedStates);
          view.runAsync();
        });
      }

      function toggleSelection(list, value) {
        const exists = list.includes(value);
        return exists ? list.filter((v) => v !== value) : [...list, value];
      }

      function handleClubHover(datum) {
        if (datum && datum.club) {
          sharedState.hoverClub = datum.club;
          sharedState.hoverState = datum.state || sharedState.hoverState;
          syncViews();
        }
      }

      function clearClubHover() {
        sharedState.hoverClub = null;
        if (sharedState.selectedStates.length === 0) {
          sharedState.hoverState = null;
        }
        syncViews();
      }

      function handleStateHover(datum) {
        if (datum && datum.state) {
          sharedState.hoverState = datum.state;
          syncViews();
        }
      }

      function clearStateHover() {
        sharedState.hoverState = null;
        syncViews();
      }

      function handleClubClick(datum) {
        if (datum && datum.club) {
          sharedState.selectedClubs = toggleSelection(sharedState.selectedClubs, datum.club);
          if (datum.state) {
            sharedState.hoverState = datum.state;
          }
          syncViews();
        }
      }

      function handleStateClick(datum) {
        if (datum && datum.state) {
          sharedState.selectedStates = toggleSelection(sharedState.selectedStates, datum.state);
          syncViews();
        }
      }

      mapView.addEventListener("pointerover", (event, item) => {
        if (item && item.datum) {
          handleClubHover(item.datum);
        }
      });

      mapView.addEventListener("pointerout", () => {
        clearClubHover();
      });

      mapView.addEventListener("click", (event, item) => {
        if (item && item.datum) {
          handleClubClick(item.datum);
        }
      });

      leaderboardView.addEventListener("pointerover", (event, item) => {
        if (item && item.datum && item.datum.club) {
          sharedState.hoverState = item.datum.state || null;
          handleClubHover(item.datum);
        }
      });

      leaderboardView.addEventListener("pointerout", () => {
        clearClubHover();
      });

      leaderboardView.addEventListener("click", (event, item) => {
        if (item && item.datum) {
          handleClubClick(item.datum);
        }
      });

      stateView.addEventListener("pointerover", (event, item) => {
        if (item && item.datum) {
          handleStateHover(item.datum);
        }
      });

      stateView.addEventListener("pointerout", () => {
        clearStateHover();
      });

      stateView.addEventListener("click", (event, item) => {
        if (item && item.datum) {
          handleStateClick(item.datum);
        }
      });

      document.getElementById("reset-filters").addEventListener("click", () => {
        sharedState.hoverClub = null;
        sharedState.hoverState = null;
        sharedState.selectedClubs = [];
        sharedState.selectedStates = [];
        syncViews();
      });

      syncViews();
    }).catch((error) => {
      console.error("Error embedding visualisations", error);
    });
  </script>
</body>
</html>
